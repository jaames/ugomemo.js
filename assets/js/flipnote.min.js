/*!!
flipnote.js v5.3.0 (web build)
https://flipnote.js.org
A JavaScript library for parsing, converting, and in-browser playback of the proprietary animation formats used by Nintendo's Flipnote Studio and Flipnote Studio 3D apps.
2018 - 2021 James Daniel
Flipnote Studio is (c) Nintendo Co., Ltd. This project isn't affiliated with or endorsed by them in any way.
Keep on Flipnoting!
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).flipnote={})}(this,(function(t){"use strict";var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(t,r)};function r(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}var i=function(){return(i=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var n in e=arguments[r])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};function n(t,e,r,i){return new(r||(r=Promise))((function(n,a){function o(t){try{u(i.next(t))}catch(t){a(t)}}function s(t){try{u(i.throw(t))}catch(t){a(t)}}function u(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,s)}u((i=i.apply(t,e||[])).next())}))}function a(t,e){var r,i,n,a,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,i&&(n=2&a[0]?i.return:a[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,a[1])).done)return n;switch(i=0,n&&(a=[2&a[0],n.value]),a[0]){case 0:case 1:n=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,i=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(n=o.trys,(n=n.length>0&&n[n.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){o.label=a[1];break}if(6===a[0]&&o.label<n[1]){o.label=n[1],n=a;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(a);break}n[2]&&o.ops.pop(),o.trys.pop();continue}a=e.call(t,o)}catch(t){a=[6,t],i=0}finally{r=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}function o(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;var i=Array(t),n=0;for(e=0;e<r;e++)for(var a=arguments[e],o=0,s=a.length;o<s;o++,n++)i[n]=a[o];return i}var s=function(){function t(){this.pageSize=t.pageSize,this.currPageIndex=-1,this.pages=[],this.pointer=0,this.newPage()}return t.prototype.newPage=function(){this.pages[++this.currPageIndex]=new Uint8Array(this.pageSize),this.currPage=this.pages[this.currPageIndex],this.pointer=0},t.prototype.getData=function(){for(var t=new Uint8Array(this.currPageIndex*this.pageSize+this.pointer),e=0;e<this.pages.length;e++){var r=this.pages[e];e===this.currPageIndex?t.set(r.slice(0,this.pointer),e*this.pageSize):t.set(r,e*this.pageSize)}return t},t.prototype.getBuffer=function(){return this.getData().buffer},t.prototype.writeByte=function(t){this.pointer>=this.pageSize&&this.newPage(),this.currPage[this.pointer++]=t},t.prototype.writeBytes=function(t,e,r){for(var i=r||t.length,n=e||0;n<i;n++)this.writeByte(t[n])},t.pageSize=2048,t}(),u=function(){function t(t){this.buffer=t,this.data=new DataView(t),this.pointer=0}return Object.defineProperty(t.prototype,"bytes",{get:function(){return new Uint8Array(this.buffer)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"byteLength",{get:function(){return this.data.byteLength},enumerable:!1,configurable:!0}),t.prototype.seek=function(t,e){switch(e){case 2:this.pointer=this.data.byteLength+t;break;case 1:this.pointer+=t;break;case 0:default:this.pointer=t}},t.prototype.readUint8=function(){var t=this.data.getUint8(this.pointer);return this.pointer+=1,t},t.prototype.writeUint8=function(t){this.data.setUint8(this.pointer,t),this.pointer+=1},t.prototype.readInt8=function(){var t=this.data.getInt8(this.pointer);return this.pointer+=1,t},t.prototype.writeInt8=function(t){this.data.setInt8(this.pointer,t),this.pointer+=1},t.prototype.readUint16=function(t){void 0===t&&(t=!0);var e=this.data.getUint16(this.pointer,t);return this.pointer+=2,e},t.prototype.writeUint16=function(t,e){void 0===e&&(e=!0),this.data.setUint16(this.pointer,t,e),this.pointer+=2},t.prototype.readInt16=function(t){void 0===t&&(t=!0);var e=this.data.getInt16(this.pointer,t);return this.pointer+=2,e},t.prototype.writeInt16=function(t,e){void 0===e&&(e=!0),this.data.setInt16(this.pointer,t,e),this.pointer+=2},t.prototype.readUint32=function(t){void 0===t&&(t=!0);var e=this.data.getUint32(this.pointer,t);return this.pointer+=4,e},t.prototype.writeUint32=function(t,e){void 0===e&&(e=!0),this.data.setUint32(this.pointer,t,e),this.pointer+=4},t.prototype.readInt32=function(t){void 0===t&&(t=!0);var e=this.data.getInt32(this.pointer,t);return this.pointer+=4,e},t.prototype.writeInt32=function(t,e){void 0===e&&(e=!0),this.data.setInt32(this.pointer,t,e),this.pointer+=4},t.prototype.readBytes=function(t){var e=new Uint8Array(this.data.buffer,this.pointer,t);return this.pointer+=e.byteLength,e},t.prototype.writeBytes=function(t){var e=this;t.forEach((function(t){return e.writeUint8(t)}))},t.prototype.readHex=function(t,e){void 0===e&&(e=!1);for(var r=this.readBytes(t),i=[],n=0;n<r.length;n++)i.push(r[n].toString(16).padStart(2,"0"));return e&&i.reverse(),i.join("").toUpperCase()},t.prototype.readChars=function(t){for(var e=this.readBytes(t),r="",i=0;i<e.length;i++){var n=e[i];if(0===n)break;r+=String.fromCharCode(n)}return r},t.prototype.writeChars=function(t){for(var e=0;e<t.length;e++){var r=t.charCodeAt(e);this.writeUint8(r)}},t.prototype.readWideChars=function(t){for(var e=new Uint16Array(this.data.buffer,this.pointer,t),r="",i=0;i<e.length;i++){var n=e[i];if(0==n)break;r+=String.fromCharCode(n)}return this.pointer+=e.byteLength,r},t}(),h=new Int8Array([-1,2,-1,2]),f=new Int8Array([-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8]),c=new Int16Array([7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767,0]);function l(t,e,r){return t<e?e:t>r?r:t}function p(t,e,r){return r<0||r>=e?0:t[r]}function d(t){for(var e=t.length,r=0,i=0;i<e;i++){var n=t[i];(n<=-32768||n>=32767)&&(r+=1)}return r/e}function y(t,e){if(void 0===e&&(e="Assert failed"),!t)throw console.trace(e),new Error(e)}function m(t,e,r,i){void 0===i&&(i=""),y(t>=e&&t<=r,"Value "+i+" should be between "+e+" and "+r)}var g="undefined"!=typeof window&&void 0!==window.document;function v(){return y(g,"This feature is only available in browser environments")}var b="undefined"!=typeof process&&null!=process.versions&&null!=process.versions.node;var w;function A(t){return new Date(1e3*(t+946684800))}function F(t,e){return 100*t*(1/e)/100}(w=t.FlipnoteRegion||(t.FlipnoteRegion={})).EUR="EUR",w.USA="USA",w.JPN="JPN",w.UNKNOWN="UNKNOWN";var P=/^[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}$/,E=/^[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{6}$/,x=/^(00|10|12|14)[0-9a-f]{2}-[0-9a-f]{4}-[0-9a-f]{3}0-[0-9a-f]{4}[0159]{1}[0-9a-f]{1}$/;function T(t){return P.test(t)}function S(t){return E.test(t)}function _(t){return x.test(t)}function U(e){switch(e.charAt(0)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}}function k(e){if(_(e))switch(e.charAt(19)){case"0":case"1":return t.FlipnoteRegion.JPN;case"5":return t.FlipnoteRegion.USA;case"9":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}switch(e.slice(0,2)){case"00":return t.FlipnoteRegion.JPN;case"02":return t.FlipnoteRegion.USA;case"04":return t.FlipnoteRegion.EUR;default:return t.FlipnoteRegion.UNKNOWN}}var L,C,B=Object.freeze({__proto__:null,get FlipnoteRegion(){return t.FlipnoteRegion},isPpmFsid:T,isKwzFsid:S,isKwzDsiLibraryFsid:_,isFsid:function(t){return T(t)||S(t)},getPpmFsidRegion:U,getKwzFsidRegion:k,getFsidRegion:function(e){return T(e)?U(e):S(e)?k(e):t.FlipnoteRegion.UNKNOWN}});!function(){if(!g)return function(){};var t=document.createElement("a")}();(L=t.FlipnoteFormat||(t.FlipnoteFormat={})).PPM="PPM",L.KWZ="KWZ",(C=t.FlipnoteAudioTrack||(t.FlipnoteAudioTrack={}))[C.BGM=0]="BGM",C[C.SE1=1]="SE1",C[C.SE2=2]="SE2",C[C.SE3=3]="SE3",C[C.SE4=4]="SE4";for(var R=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.isFolderIcon=!1,e.isComment=!1,e.isDsiLibraryNote=!1,e}return r(e,t),e.prototype.hasAudioTrack=function(t){return this.soundMeta.has(t)&&this.soundMeta.get(t).length>0},e}(u),M=[.5,.5,1,2,4,6,12,20,30],I={WHITE:[255,255,255,255],BLACK:[14,14,14,255],RED:[255,42,42,255],BLUE:[10,57,255,255]},O=function(e){function i(r,n){var a=e.call(this,r)||this;return a.format=t.FlipnoteFormat.PPM,a.imageWidth=i.width,a.imageHeight=i.height,a.imageOffsetX=0,a.imageOffsetY=0,a.numLayers=i.numLayers,a.rawSampleRate=i.rawSampleRate,a.sampleRate=i.sampleRate,a.globalPalette=i.globalPalette,a.prevDecodedFrame=null,a.decodeHeader(),a.decodeAnimationHeader(),a.decodeSoundHeader(),0!=(a.version>>4&15)&&a.decodeMeta(),a.layerBuffers=[new Uint8Array(i.width*i.height),new Uint8Array(i.width*i.height)],a.prevLayerBuffers=[new Uint8Array(i.width*i.height),new Uint8Array(i.width*i.height)],a.lineEncodingBuffers=[new Uint8Array(i.height),new Uint8Array(i.height)],a.prevDecodedFrame=null,a}return r(i,e),i.validateFSID=function(t){return/[0159]{1}[0-9A-F]{6}0[0-9A-F]{8}/.test(t)},i.validateFilename=function(t){return/[0-9A-F]{6}_[0-9A-F]{13}_[0-9]{3}/.test(t)},i.prototype.decodeHeader=function(){y(16<this.byteLength),this.seek(4),this.frameDataLength=this.readUint32(),this.soundDataLength=this.readUint32(),this.frameCount=this.readUint16()+1,this.version=this.readUint16()},i.prototype.readFilename=function(){return this.readHex(3)+"_"+this.readChars(13)+"_"+this.readUint16().toString().padStart(3,"0")},i.prototype.decodeMeta=function(){y(1704<this.byteLength),this.seek(16);var t=this.readUint16(),e=this.readInt16(),r=this.readWideChars(11),i=this.readWideChars(11),n=this.readWideChars(11),a=this.readHex(8,!0),o=this.readHex(8,!0),s=this.readFilename(),u=this.readFilename(),h=this.readHex(8,!0);this.seek(154);var f=A(this.readInt32());this.seek(1702);var c=this.readUint16();this.thumbFrameIndex=e,this.layerVisibility={1:0==(16&c),2:0==(32&c),3:!1},this.isSpinoff=o!==a||o!==h,this.meta={lock:1===t,loop:1==(c>>1&1),isSpinoff:this.isSpinoff,frameCount:this.frameCount,frameSpeed:this.frameSpeed,bgmSpeed:this.bgmSpeed,duration:this.duration,thumbIndex:e,timestamp:f,root:{username:r,fsid:h,region:U(h),filename:null},parent:{username:i,fsid:a,region:U(a),filename:s},current:{username:n,fsid:o,region:U(o),filename:u}}},i.prototype.decodeAnimationHeader=function(){this.seek(1696);var t=this.readUint16(),e=t/4;y(e<=this.frameCount),this.seek(1704);for(var r=new Uint32Array(e),i=0;i<e;i++){var n=1704+t+this.readUint32();y(n<this.byteLength,"Frame "+i+" pointer is out of bounds"),r[i]=n}this.frameOffsets=r},i.prototype.decodeSoundHeader=function(){var e=1696+this.frameDataLength+this.frameCount;y(e<this.byteLength),e%4!=0&&(e+=4-e%4),this.seek(e);var r=this.readUint32(),i=this.readUint32(),n=this.readUint32(),a=this.readUint32();this.frameSpeed=8-this.readUint8(),this.bgmSpeed=8-this.readUint8(),y(this.frameSpeed<=8&&this.bgmSpeed<=8),e+=32,this.framerate=M[this.frameSpeed],this.duration=F(this.frameCount,this.framerate),this.bgmrate=M[this.bgmSpeed];var o=new Map;o.set(t.FlipnoteAudioTrack.BGM,{ptr:e,length:r}),o.set(t.FlipnoteAudioTrack.SE1,{ptr:e+=r,length:i}),o.set(t.FlipnoteAudioTrack.SE2,{ptr:e+=i,length:n}),o.set(t.FlipnoteAudioTrack.SE3,{ptr:e+=n,length:a}),this.soundMeta=o},i.prototype.isNewFrame=function(t){return this.seek(this.frameOffsets[t]),this.readUint8()>>7&1},i.prototype.decodeFrame=function(t){y(t>-1&&t<this.frameCount,"Frame index "+t+" out of bounds"),this.prevDecodedFrame===t-1||this.isNewFrame(t)||0===t||this.decodeFrame(t-1),this.prevDecodedFrame=t,this.seek(this.frameOffsets[t]);var e=this.readUint8(),r=e>>7&1,n=e>>5&3;this.layerBuffers[0].fill(0),this.layerBuffers[1].fill(0);var a=0,o=0;n&&(a=this.readInt8(),o=this.readInt8());for(var s=0;s<2;s++){(c=this.lineEncodingBuffers[s]).fill(0);for(var u=0;u<c.length;){var h=this.readUint8();0!==h?(c[u++]=3&h,c[u++]=h>>2&3,c[u++]=h>>4&3,c[u++]=h>>6&3):u+=4}}for(s=0;s<2;s++)for(var f=this.layerBuffers[s],c=this.lineEncodingBuffers[s],l=0;l<i.height;l++){var p=l*i.width;switch(c[l]){case 0:break;case 1:for(var d=this.readUint32(!1);0!==d;d<<=1,p+=8)if(2147483648&d)for(var m=this.readUint8(),g=0;0!==m;g++,m>>=1)f[p+g]=1&m;break;case 2:f.fill(1,p,p+i.width);for(d=this.readUint32(!1);0!==d;d<<=1,p+=8)if(2147483648&d)for(m=this.readUint8(),g=0;g<8;g++,m>>=1)f[p+g]=1&m;break;case 3:m=0;for(var v=0;v<i.width;v++)v%8==0&&(m=this.readUint8()),f[p++]=1&m,m>>=1}}var b=this.layerBuffers[0],w=this.layerBuffers[1],A=this.prevLayerBuffers[0],F=this.prevLayerBuffers[1];if(!r){var P=void 0,E=void 0;for(l=0;l<i.height;l++)if(!(l-o<0)){if(l-o>=i.height)break;for(var x=0;x<i.width;x++)if(!(x-a<0)){if(x-a>=i.width)break;E=(P=x+l*i.width)-(a+o*i.width),b[P]^=A[E],w[P]^=F[E]}}}return this.prevLayerBuffers[0].set(this.layerBuffers[0]),this.prevLayerBuffers[1].set(this.layerBuffers[1]),this.layerBuffers},i.prototype.getFrameLayerOrder=function(t){return[0,1]},i.prototype.getFramePaletteIndices=function(t){this.seek(this.frameOffsets[t]);var e=this.readUint8(),r=1!=(1&e),i=[r?0:1,r?0:1,2,3];return[r?1:0,i[e>>1&3],i[e>>3&3]]},i.prototype.getFramePalette=function(t){var e=this;return this.getFramePaletteIndices(t).map((function(t){return e.globalPalette[t]}))},i.prototype.getLayerPixels=function(t,e){this.prevDecodedFrame!==t&&this.decodeFrame(t);for(var r=this.getFramePaletteIndices(t),n=this.layerBuffers[e],a=new Uint8Array(i.width*i.height),o=r[e+1],s=0;s<a.length;s++)1===n[s]&&(a[s]=o);return a},i.prototype.getFramePixels=function(t){var e=this.getFramePaletteIndices(t),r=this.decodeFrame(t),n=new Uint8Array(i.width*i.height),a=r[0],o=r[1],s=e[0],u=e[1],h=e[2];n.fill(s);for(var f=0;f<n.length;f++){var c=a[f],l=o[f];1===c?n[f]=u:1===l&&(n[f]=h)}return n},i.prototype.decodeSoundFlags=function(){y(1696+this.frameDataLength<this.byteLength),this.seek(1696+this.frameDataLength);for(var t=this.frameCount,e=this.readBytes(t),r=new Array(t),i=0;i<t;i++){var n=e[i];r[i]=[0!=(1&n),0!=(2&n),0!=(4&n)]}return r},i.prototype.getAudioTrackRaw=function(t){var e=this.soundMeta.get(t);return y(e.ptr+e.length<this.byteLength),this.seek(e.ptr),this.readBytes(e.length)},i.prototype.decodeAudioTrack=function(t){for(var e=this.getAudioTrackRaw(t),r=e.length,i=new Int16Array(2*r),n=0,a=0,o=0,s=0,u=0,h=!0;n<r;){o=h?15&e[n]:e[n++]>>4,h=!h;var p=c[s],d=p>>3;1&o&&(d+=p>>2),2&o&&(d+=p>>1),4&o&&(d+=p),8&o&&(d=-d),u=l(u+=d,-32768,32767),s=l(s+=f[o],0,88),i[a++]=u}return i},i.prototype.getAudioTrackPcm=function(e,r){void 0===r&&(r=this.sampleRate);var i=this.decodeAudioTrack(e),n=this.rawSampleRate;if(e===t.FlipnoteAudioTrack.BGM){var a=1/this.bgmrate/(1/this.framerate);n=this.rawSampleRate*a}return n!==r?function(t,e,r){for(var i=t.length,n=i/e*r,a=new Int16Array(n),o=e/r,s=0;s<n;s++)a[s]=p(t,i,Math.floor(s*o));return a}(i,n,r):i},i.prototype.pcmAudioMix=function(t,e,r){void 0===r&&(r=0);for(var i=t.length,n=e.length,a=0;a<i&&!(r+a>n);a++){var o=e[r+a]+t[a]/2;e[r+a]=l(o,-32768,32767)}},i.prototype.getAudioMasterPcm=function(e){void 0===e&&(e=this.sampleRate);var r=Math.ceil(this.duration*e),i=new Int16Array(r),n=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),s=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3);if(n){var u=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,e);this.pcmAudioMix(u,i,0)}if(a||o||s)for(var h=e/this.framerate,f=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,e):null,c=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,e):null,l=s?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,e):null,p=this.decodeSoundFlags(),y=0;y<this.frameCount;y++){var m=Math.ceil(y*h),g=p[y];a&&g[0]&&this.pcmAudioMix(f,i,m),o&&g[1]&&this.pcmAudioMix(c,i,m),s&&g[2]&&this.pcmAudioMix(l,i,m)}return this.audioClipRatio=d(i),i},i.defaultSettings={},i.format=t.FlipnoteFormat.PPM,i.width=256,i.height=192,i.numLayers=2,i.rawSampleRate=8192,i.sampleRate=32768,i.globalPalette=[I.WHITE,I.BLACK,I.RED,I.BLUE],i}(R),z=[.2,.5,1,2,4,6,8,12,20,24,30],N={WHITE:[255,255,255,255],BLACK:[16,16,16,255],RED:[255,16,16,255],YELLOW:[255,231,0,255],GREEN:[0,134,49,255],BLUE:[0,56,206,255],NONE:[255,255,255,0]},D=new Uint16Array(16),H=0;H<16;H++)D[H]=(1<<H)-1;for(var W=new Uint8Array(52488),V=new Uint8Array(52488),j=0,G=0;G<3;G++)for(var K=0;K<3;K++)for(var q=0;q<3;q++)for(var X=0;X<3;X++)for(var Y=0;Y<3;Y++)for(var $=0;$<3;$++)for(var J=0;J<3;J++)for(var Z=0;Z<3;Z++)W.set([K,G,X,q,$,Y,Z,J],j),V.set([G,X,q,$,Y,Z,J,K],j),j+=8;var Q=new Uint8Array(256),tt=new Uint8Array(256);[0,3280,6560,729,2187,81,243,9,27,1,3,1458,4374,162,486,18,54,2,6,2916,2268,324,252,36,28,4,820,2460,1640,4920,4100,5740].forEach((function(t,e){var r=8*t,i=W.subarray(r,r+8),n=V.subarray(r,r+8);Q.set(i,8*e),tt.set(n,8*e)}));var et,rt=function(e){function n(r,a){void 0===a&&(a={});var o=e.call(this,r)||this;return o.format=t.FlipnoteFormat.KWZ,o.imageWidth=n.width,o.imageHeight=n.height,o.imageOffsetX=0,o.imageOffsetY=0,o.numLayers=n.numLayers,o.rawSampleRate=n.rawSampleRate,o.sampleRate=n.sampleRate,o.globalPalette=n.globalPalette,o.prevFrameIndex=null,o.bitIndex=0,o.bitValue=0,o.settings=i(i({},n.defaultSettings),a),o.buildSectionMap(),o.layers=[new Uint8Array(n.width*n.height),new Uint8Array(n.width*n.height),new Uint8Array(n.width*n.height)],o.sectionMap.has("KIC")?(o.isFolderIcon=!0,o.imageWidth=24,o.imageHeight=24,o.frameCount=1,o.frameSpeed=0,o.framerate=z[0],o.thumbFrameIndex=0,o.getFrameOffsets()):o.sectionMap.has("KSN")?(o.decodeMeta(),o.getFrameOffsets(),o.decodeSoundHeader()):(o.isComment=!0,o.decodeMeta(),o.getFrameOffsets()),o.settings.dsiLibraryNote&&(o.isDsiLibraryNote=!0),o.settings.borderCrop&&(o.isDsiLibraryNote?(o.imageOffsetX=32,o.imageOffsetY=24,o.imageWidth=256,o.imageHeight=192):o.isFolderIcon||(o.imageOffsetX=5,o.imageOffsetY=5,o.imageWidth=310,o.imageHeight=230)),o}return r(n,e),n.prototype.buildSectionMap=function(){this.seek(0);for(var t=this.byteLength-256,e=new Map,r=0,i=0;i<t&&r<6;){this.seek(i);var n=this.readChars(4).substring(0,3),a=this.readUint32();e.set(n,{ptr:i,length:a}),i+=a+8,r+=1}this.sectionMap=e,y(e.has("KMC")&&e.has("KMI"))},n.prototype.readBits=function(t){if(this.bitIndex+t>16){var e=this.readUint16();this.bitValue|=e<<16-this.bitIndex,this.bitIndex-=16}var r=this.bitValue&D[t];return this.bitValue>>=t,this.bitIndex+=t,r},n.prototype.readFsid=function(){if(this.settings.dsiLibraryNote)return this.readHex(10,!0).slice(2,18);var t=this.readHex(10);return(t.slice(0,4)+"-"+t.slice(4,8)+"-"+t.slice(8,12)+"-"+t.slice(12,18)).toLowerCase()},n.prototype.readFilename=function(){var t=this.pointer,e=this.readChars(28);if(28===e.length)return e;this.seek(t);var r=this.readHex(3),i=this.readChars(13),n=this.readUint16().toString().padStart(3,"0");return this.seek(t+28),r+"_"+i+"_"+n},n.prototype.decodeMeta=function(){if(this.settings.quickMeta)return this.decodeMetaQuick();y(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+12);var t=A(this.readUint32()),e=A(this.readUint32()),r=(this.readUint32(),this.readFsid()),i=this.readFsid(),n=this.readFsid(),a=this.readWideChars(11),o=this.readWideChars(11),s=this.readWideChars(11),u=this.readFilename(),h=this.readFilename(),f=this.readFilename(),c=this.readUint16(),l=this.readUint16(),p=this.readUint16(),d=this.readUint8(),m=this.readUint8();this.isSpinoff=n!==i||n!==r,this.frameCount=c,this.frameSpeed=d,this.framerate=z[d],this.duration=F(this.frameCount,this.framerate),this.thumbFrameIndex=l,this.layerVisibility={1:0==(1&m),2:0==(2&m),3:0==(3&m)},_(n)&&(this.isDsiLibraryNote=!0),this.meta={lock:0!=(1&p),loop:0!=(2&p),isSpinoff:this.isSpinoff,frameCount:c,frameSpeed:d,duration:this.duration,thumbIndex:l,timestamp:e,creationTimestamp:t,root:{username:a,fsid:r,region:k(r),filename:u,isDsiFilename:28!==u.length},parent:{username:o,fsid:i,region:k(i),filename:h,isDsiFilename:28!==h.length},current:{username:s,fsid:n,region:k(n),filename:f,isDsiFilename:28!==f.length}}},n.prototype.decodeMetaQuick=function(){y(this.sectionMap.has("KFH")),this.seek(this.sectionMap.get("KFH").ptr+8+196);var t=this.readUint16(),e=this.readUint16(),r=(this.readUint16(),this.readUint8()),i=this.readUint8();this.frameCount=t,this.thumbFrameIndex=e,this.frameSpeed=r,this.framerate=z[r],this.duration=F(this.frameCount,this.framerate),this.layerVisibility={1:0==(1&i),2:0==(2&i),3:0==(3&i)}},n.prototype.getFrameOffsets=function(){y(this.sectionMap.has("KMI")&&this.sectionMap.has("KMC"));var t=this.frameCount,e=this.sectionMap.get("KMI"),r=this.sectionMap.get("KMC");y(e.length/28>=t);for(var i=new Uint32Array(t),n=new Uint32Array(t),a=[],o=e.ptr+8,s=r.ptr+12,u=0;u<t;u++){this.seek(o+4);var h=this.readUint16(),f=this.readUint16(),c=this.readUint16();i[u]=o,n[u]=s,s+=h+f+c,y((o+=28)<this.byteLength,"frame"+u+" meta pointer out of bounds"),y(s<this.byteLength,"frame"+u+" data pointer out of bounds"),a.push([h,f,c])}this.frameMetaOffsets=i,this.frameDataOffsets=n,this.frameLayerSizes=a},n.prototype.decodeSoundHeader=function(){y(this.sectionMap.has("KSN"));var e=this.sectionMap.get("KSN").ptr+8;this.seek(e),this.bgmSpeed=this.readUint32(),y(this.bgmSpeed<=10),this.bgmrate=z[this.bgmSpeed];var r=new Uint32Array(this.buffer,e+4,20),i=new Map;i.set(t.FlipnoteAudioTrack.BGM,{ptr:e+=28,length:r[0]}),i.set(t.FlipnoteAudioTrack.SE1,{ptr:e+=r[0],length:r[1]}),i.set(t.FlipnoteAudioTrack.SE2,{ptr:e+=r[1],length:r[2]}),i.set(t.FlipnoteAudioTrack.SE3,{ptr:e+=r[2],length:r[3]}),i.set(t.FlipnoteAudioTrack.SE4,{ptr:e+=r[3],length:r[4]}),this.soundMeta=i},n.prototype.getFramePaletteIndices=function(t){this.seek(this.frameMetaOffsets[t]);var e=this.readUint32();return[15&e,e>>8&15,e>>12&15,e>>16&15,e>>20&15,e>>24&15,e>>28&15]},n.prototype.getFramePalette=function(t){var e=this;return this.getFramePaletteIndices(t).map((function(t){return e.globalPalette[t]}))},n.prototype.getFrameDiffingFlag=function(t){return this.seek(this.frameMetaOffsets[t]),this.readUint32()>>4&7},n.prototype.getFrameLayerSizes=function(t){return this.seek(this.frameMetaOffsets[t]+4),[this.readUint16(),this.readUint16(),this.readUint16()]},n.prototype.getFrameLayerDepths=function(t){return this.seek(this.frameMetaOffsets[t]+20),[this.readUint8(),this.readUint8(),this.readUint8()]},n.prototype.getFrameAuthor=function(t){return this.seek(this.frameMetaOffsets[t]+10),this.readHex(10)},n.prototype.getFrameSoundFlags=function(t){this.seek(this.frameMetaOffsets[t]+23);var e=this.readUint8();return[0!=(1&e),0!=(2&e),0!=(4&e),0!=(8&e)]},n.prototype.getFrameCameraFlags=function(t){this.seek(this.frameMetaOffsets[t]+26);var e=this.readUint8();return[0!=(1&e),0!=(2&e),0!=(4&e)]},n.prototype.getFrameLayerOrder=function(t){var e=this.getFrameLayerDepths(t);return[2,1,0].sort((function(t,r){return e[r]-e[t]}))},n.prototype.decodeFrame=function(t,e,r){void 0===e&&(e=7),void 0===r&&(r=!1),y(t>-1&&t<this.frameCount,"Frame index "+t+" out of bounds"),this.prevFrameIndex!==t-1&&0!==t&&(r&&(e&=~this.getFrameDiffingFlag(t+1)),0!==e&&this.decodeFrame(t-1,e,!0));for(var i=this.frameDataOffsets[t],a=this.frameLayerSizes[t],o=0;o<3&&(!this.settings.dsiLibraryNote||3!==o);o++){this.seek(i);var s=a[o];i+=s;var u=this.layers[o];if(38!==s&&0!=(e>>o&1)){this.bitIndex=16,this.bitValue=0;for(var h=0,f=0;f<240;f+=128)for(var c=0;c<320;c+=128)for(var l=0;l<128;l+=8){var p=f+l;if(p>=240)break;for(var d=0;d<128;d+=8){var m=c+d;if(m>=320)break;if(h>0)h-=1;else{var g=p*n.width+m,v=this.readBits(3);if(0===v){var b=8*this.readBits(5),w=Q.subarray(b,b+8);u.set(w,g),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320)}else if(1===v){b=8*this.readBits(13),w=W.subarray(b,b+8);u.set(w,g),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320),u.set(w,g+=320)}else if(2===v){b=8*this.readBits(5);var A=Q.subarray(b,b+8),F=tt.subarray(b,b+8);u.set(A,g),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320)}else if(3===v){b=8*this.readBits(13),A=W.subarray(b,b+8),F=V.subarray(b,b+8);u.set(A,g),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320)}else if(4===v)for(var P=this.readBits(8),E=1;E<255;E<<=1){if(P&E){b=8*this.readBits(5),w=Q.subarray(b,b+8);u.set(w,g)}else{b=8*this.readBits(13),w=W.subarray(b,b+8);u.set(w,g)}g+=320}else{if(5===v){h=this.readBits(5);continue}if(7===v){var x=this.readBits(2);A=void 0,F=void 0;if(0!==this.readBits(1)){var T=8*this.readBits(5),S=8*this.readBits(5);A=Q.subarray(T,T+8),F=Q.subarray(S,S+8),x+=1}else{T=8*this.readBits(13),S=8*this.readBits(13);A=W.subarray(T,T+8),F=W.subarray(S,S+8)}switch(x%4){case 0:u.set(A,g),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320);break;case 1:u.set(A,g),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(A,g+=320);break;case 2:u.set(A,g),u.set(F,g+=320),u.set(A,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(A,g+=320),u.set(F,g+=320);break;case 3:u.set(A,g),u.set(F,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320),u.set(F,g+=320),u.set(A,g+=320),u.set(F,g+=320)}}}}}}}}return this.prevFrameIndex=t,this.layers},n.prototype.getLayerPixels=function(t,e){this.prevFrameIndex!==t&&this.decodeFrame(t);for(var r=this.layers[e],i=this.getFramePaletteIndices(t),a=2*e+1,o=this.imageWidth,s=this.imageHeight,u=this.imageOffsetX,h=this.imageOffsetY,f=new Uint8Array(o*s),c=h,l=0;l<s;c++,l++)for(var p=u,d=0;d<o;p++,d++){var y=l*o+d,m=r[c*n.width+p];1===m?f[y]=i[a]:2===m&&(f[y]=i[a+1])}return f},n.prototype.getFramePixels=function(t){this.prevFrameIndex!==t&&this.decodeFrame(t);var e=this.getFrameLayerOrder(t),r=this.layers[e[2]],i=this.layers[e[1]],a=this.layers[e[0]],o=this.getFramePaletteIndices(t),s=2*e[2],u=2*e[1],h=2*e[0],f=this.imageWidth,c=this.imageHeight,l=this.imageOffsetX,p=this.imageOffsetY,d=new Uint8Array(f*c);d.fill(o[0]);for(var y=p,m=0;m<c;y++,m++)for(var g=l,v=0;v<f;g++,v++){var b=y*n.width+g,w=m*f+v,A=r[b],F=i[b],P=a[b];0!==A?d[w]=o[s+A]:0!==F?d[w]=o[u+F]:0!==P&&(d[w]=o[h+P])}return d},n.prototype.decodeSoundFlags=function(){for(var t=[],e=0;e<this.frameCount;e++)t.push(this.getFrameSoundFlags(e));return t},n.prototype.getAudioTrackRaw=function(t){var e=this.soundMeta.get(t);return y(e.ptr+e.length<this.byteLength),new Uint8Array(this.buffer,e.ptr,e.length)},n.prototype.decodeAudioTrack=function(t){var e=this.getAudioTrackRaw(t),r=new Int16Array(981840),i=0,n=0,a=0,o=0,s=0,u=0;(this.settings.originalAudio||this.isDsiLibraryNote)&&(a=40);for(var p=0;p<e.length;p++)for(var d=e[p],y=0;y<8;)a<18||y>4?(o=3&d,u=(s=c[a])>>3,1&o&&(u+=s),2&o&&(u=-u),n+=u,a+=h[o],d>>=2,y+=2):(o=15&d,u=(s=c[a])>>3,1&o&&(u+=s>>2),2&o&&(u+=s>>1),4&o&&(u+=s),8&o&&(u=-u),n+=u,a+=f[o],d>>=4,y+=4),a=l(a,0,79),n=l(n,-2048,2047),r[i]=16*n,i+=1;return r.slice(0,i)},n.prototype.getAudioTrackPcm=function(e,r){void 0===r&&(r=this.sampleRate);var i=this.decodeAudioTrack(e),n=this.rawSampleRate;if(e===t.FlipnoteAudioTrack.BGM){var a=1/this.bgmrate/(1/this.framerate);n=this.rawSampleRate*a}return n!==r?function(t,e,r){for(var i=t.length,n=i/e*r,a=new Int16Array(n),o=e/r,s=0,u=0,h=0,f=0;s<n;s++)u=s*o,h=Math.floor(u),f=u%1,a[s]=(1-f)*p(t,i,h)+f*p(t,i,h+1);return a}(i,n,r):i},n.prototype.pcmAudioMix=function(t,e,r){void 0===r&&(r=0);for(var i=t.length,n=e.length,a=0;a<i&&!(r+a>n);a++){var o=e[r+a]+t[a];e[r+a]=l(o,-32768,32767)}},n.prototype.getAudioMasterPcm=function(e){void 0===e&&(e=this.sampleRate);var r=Math.ceil(this.duration*e),i=new Int16Array(r),n=this.hasAudioTrack(t.FlipnoteAudioTrack.BGM),a=this.hasAudioTrack(t.FlipnoteAudioTrack.SE1),o=this.hasAudioTrack(t.FlipnoteAudioTrack.SE2),s=this.hasAudioTrack(t.FlipnoteAudioTrack.SE3),u=this.hasAudioTrack(t.FlipnoteAudioTrack.SE4);if(n){var h=this.getAudioTrackPcm(t.FlipnoteAudioTrack.BGM,e);this.pcmAudioMix(h,i,0)}if(a||o||s||u)for(var f=e/this.framerate,c=a?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE1,e):null,l=o?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE2,e):null,p=s?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE3,e):null,y=u?this.getAudioTrackPcm(t.FlipnoteAudioTrack.SE4,e):null,m=0;m<this.frameCount;m++){var g=this.getFrameSoundFlags(m),v=Math.ceil(m*f);a&&g[0]&&this.pcmAudioMix(c,i,v),o&&g[1]&&this.pcmAudioMix(l,i,v),s&&g[2]&&this.pcmAudioMix(p,i,v),u&&g[3]&&this.pcmAudioMix(y,i,v)}return this.audioClipRatio=d(i),i},n.defaultSettings={quickMeta:!1,dsiLibraryNote:!1,borderCrop:!1,originalAudio:!1},n.format=t.FlipnoteFormat.KWZ,n.width=320,n.height=240,n.numLayers=3,n.rawSampleRate=16364,n.sampleRate=32768,n.globalPalette=[N.WHITE,N.BLACK,N.RED,N.YELLOW,N.GREEN,N.BLUE,N.NONE],n}(R),it=[{matches:function(t){return g&&"string"==typeof t},load:function(t,e,r){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer",i.onreadystatechange=function(t){4===i.readyState&&(i.status>=200&&i.status<300?e(i.response):r({type:"httpError",status:i.status,statusText:i.statusText}))},i.send(null)}},{matches:function(t){return b&&"string"==typeof t},load:function(t,e,r){require("https").get(t,(function(t){var i=[];t.on("data",(function(t){return i.push(t)})),t.on("end",(function(){var t=Buffer.concat(i);e(t.buffer)})),t.on("error",(function(t){return r(t)}))}))}},{matches:function(t){return g&&"undefined"!=typeof File&&t instanceof File},load:function(t,e,r){y("undefined"!=typeof FileReader);var i=new FileReader;i.onload=function(t){e(i.result)},i.onerror=function(t){r({type:"fileReadError"})},i.readAsArrayBuffer(t)}},{matches:function(t){return b&&t instanceof Buffer},load:function(t,e,r){e(t.buffer)}},{matches:function(t){return t instanceof ArrayBuffer},load:function(t,e,r){e(t)}}];function nt(t,e){return function(t){return new Promise((function(e,r){for(var i=0;i<it.length;i++){var n=it[i];if(n.matches(t))return n.load(t,e,r)}r("No loader available for source type")}))}(t).then((function(t){return new Promise((function(r,i){var n=new Uint8Array(t.slice(0,4)),a=n[0]<<24|n[1]<<16|n[2]<<8|n[3];1346458177===a?r(new O(t,e)):1262897152==(4294967040&a)||1263092480==(4294967040&a)?r(new rt(t,e)):i("Could not identify source as a valid Flipnote file")}))}))}(et=t.PlayerEvent||(t.PlayerEvent={})).__Any="any",et.Play="play",et.Pause="pause",et.CanPlay="canplay",et.CanPlayThrough="canplaythrough",et.SeekStart="seeking",et.SeekEnd="seeked",et.Duration="durationchange",et.Loop="loop",et.Ended="ended",et.VolumeChange="volumechange",et.Progress="progress",et.TimeUpdate="timeupdate",et.FrameUpdate="frameupdate",et.FrameNext="framenext",et.FramePrev="frameprev",et.FrameFirst="framefirst",et.FrameLast="framelast",et.Ready="ready",et.Load="load",et.LoadStart="loadstart",et.LoadedData="loadeddata",et.LoadedMeta="loadedmetadata",et.Emptied="emptied",et.Close="close",et.Error="error",et.Destroy="destroy";var at=[t.PlayerEvent.Play,t.PlayerEvent.Pause,t.PlayerEvent.CanPlay,t.PlayerEvent.CanPlayThrough,t.PlayerEvent.SeekStart,t.PlayerEvent.SeekEnd,t.PlayerEvent.Duration,t.PlayerEvent.Loop,t.PlayerEvent.Ended,t.PlayerEvent.VolumeChange,t.PlayerEvent.Progress,t.PlayerEvent.TimeUpdate,t.PlayerEvent.FrameUpdate,t.PlayerEvent.FrameNext,t.PlayerEvent.FramePrev,t.PlayerEvent.FrameFirst,t.PlayerEvent.FrameLast,t.PlayerEvent.Ready,t.PlayerEvent.Load,t.PlayerEvent.LoadStart,t.PlayerEvent.LoadedData,t.PlayerEvent.LoadedMeta,t.PlayerEvent.Emptied,t.PlayerEvent.Close,t.PlayerEvent.Error];function ot(t){if(t instanceof Int8Array)return 5120;if(t instanceof Uint8Array)return 5121;if(t instanceof Uint8ClampedArray)return 5121;if(t instanceof Int16Array)return 5122;if(t instanceof Uint16Array)return 5123;if(t instanceof Int32Array)return 5124;if(t instanceof Uint32Array)return 5125;if(t instanceof Float32Array)return 5126;throw new Error("unsupported typed array type")}const st="undefined"!=typeof SharedArrayBuffer?function(t){return t&&t.buffer&&(t.buffer instanceof ArrayBuffer||t.buffer instanceof SharedArrayBuffer)}:function(t){return t&&t.buffer&&t.buffer instanceof ArrayBuffer};function ut(t,e){return"undefined"!=typeof WebGLTexture&&e instanceof WebGLTexture}const ht="";function ft(t,e,r,i){if(n=e,"undefined"!=typeof WebGLBuffer&&n instanceof WebGLBuffer)return e;var n;r=r||34962;const a=t.createBuffer();return function(t,e,r,i,n){t.bindBuffer(e,r),t.bufferData(e,i,n||35044)}(t,r,a,e,i),a}function ct(t){return"indices"===t}const lt=/coord|texture/i,pt=/color|colour/i;function dt(t,e){let r;if(r=lt.test(t)?2:pt.test(t)?4:3,e%r>0)throw new Error(`Can not guess numComponents for attribute '${t}'. Tried ${r} but ${e} values is not evenly divisible by ${r}. You should specify it.`);return r}function yt(t,e){if(st(t))return t;if(st(t.data))return t.data;Array.isArray(t)&&(t={data:t});let r=t.type;return r||(r=ct(e)?Uint16Array:Float32Array),new r(t.data)}function mt(t,e){const r={};return Object.keys(e).forEach((function(i){if(!ct(i)){const a=e[i],o=a.attrib||a.name||a.attribName||ht+i;if(a.value){if(!Array.isArray(a.value)&&!st(a.value))throw new Error("array.value is not array or typedarray");r[o]={value:a.value}}else{let e,s,u,h;if(a.buffer&&a.buffer instanceof WebGLBuffer)e=a.buffer,h=a.numComponents||a.size,s=a.type,u=a.normalize;else if("number"==typeof a||"number"==typeof a.data){const r=a.data||a,o=a.type||Float32Array,f=r*o.BYTES_PER_ELEMENT;s=function(t){if(t===Int8Array)return 5120;if(t===Uint8Array)return 5121;if(t===Uint8ClampedArray)return 5121;if(t===Int16Array)return 5122;if(t===Uint16Array)return 5123;if(t===Int32Array)return 5124;if(t===Uint32Array)return 5125;if(t===Float32Array)return 5126;throw new Error("unsupported typed array type")}(o),u=void 0!==a.normalize?a.normalize:(n=o)===Int8Array||n===Uint8Array,h=a.numComponents||a.size||dt(i,r),e=t.createBuffer(),t.bindBuffer(34962,e),t.bufferData(34962,f,a.drawType||35044)}else{const r=yt(a,i);e=ft(t,r,void 0,a.drawType),s=ot(r),u=void 0!==a.normalize?a.normalize:function(t){return t instanceof Int8Array||t instanceof Uint8Array}(r),h=function(t,e){return t.numComponents||t.size||dt(e,function(t){return t.length?t:t.data}(t).length)}(a,i)}r[o]={buffer:e,numComponents:h,type:s,normalize:u,stride:a.stride||0,offset:a.offset||0,divisor:void 0===a.divisor?void 0:a.divisor,drawType:a.drawType}}}var n})),t.bindBuffer(34962,null),r}const gt=["position","positions","a_position"];function vt(t,e,r){const i=mt(t,e),n=Object.assign({},r||{});n.attribs=Object.assign({},r?r.attribs:{},i);const a=e.indices;if(a){const e=yt(a,"indices");n.indices=ft(t,e,34963),n.numElements=e.length,n.elementType=ot(e)}else n.numElements||(n.numElements=function(t,e){let r,i;for(i=0;i<gt.length&&(r=gt[i],!(r in e))&&(r=ht+r,!(r in e));++i);i===gt.length&&(r=Object.keys(e)[0]);const n=e[r];t.bindBuffer(34962,n.buffer);const a=t.getBufferParameter(34962,34660);var o;t.bindBuffer(34962,null);const s=a/(5120===(o=n.type)||5121===o?1:5122===o||5123===o?2:5124===o||5125===o||5126===o?4:0),u=n.numComponents||n.size,h=s/u;if(h%1!=0)throw new Error(`numComponents ${u} not correct for length ${length}`);return h}(t,n.attribs));return n}function bt(t){return!!t.texStorage2D}const wt={};function At(t,e){return wt[e].bindPoint}function Ft(t,e){return function(r){t.uniform1i(e,r)}}function Pt(t,e){return function(r){t.uniform1iv(e,r)}}function Et(t,e){return function(r){t.uniform2iv(e,r)}}function xt(t,e){return function(r){t.uniform3iv(e,r)}}function Tt(t,e){return function(r){t.uniform4iv(e,r)}}function St(t,e,r,i){const n=At(0,e);return bt(t)?function(e){let a,o;ut(0,e)?(a=e,o=null):(a=e.texture,o=e.sampler),t.uniform1i(i,r),t.activeTexture(33984+r),t.bindTexture(n,a),t.bindSampler(r,o)}:function(e){t.uniform1i(i,r),t.activeTexture(33984+r),t.bindTexture(n,e)}}function _t(t,e,r,i,n){const a=At(0,e),o=new Int32Array(n);for(let t=0;t<n;++t)o[t]=r+t;return bt(t)?function(e){t.uniform1iv(i,o),e.forEach((function(e,i){let n,s;t.activeTexture(33984+o[i]),ut(0,e)?(n=e,s=null):(n=e.texture,s=e.sampler),t.bindSampler(r,s),t.bindTexture(a,n)}))}:function(e){t.uniform1iv(i,o),e.forEach((function(e,r){t.activeTexture(33984+o[r]),t.bindTexture(a,e)}))}}function Ut(t,e){return function(r){if(r.value)switch(t.disableVertexAttribArray(e),r.value.length){case 4:t.vertexAttrib4fv(e,r.value);break;case 3:t.vertexAttrib3fv(e,r.value);break;case 2:t.vertexAttrib2fv(e,r.value);break;case 1:t.vertexAttrib1fv(e,r.value);break;default:throw new Error("the length of a float constant value must be between 1 and 4!")}else t.bindBuffer(34962,r.buffer),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,r.numComponents||r.size,r.type||5126,r.normalize||!1,r.stride||0,r.offset||0),void 0!==r.divisor&&t.vertexAttribDivisor(e,r.divisor)}}function kt(t,e){return function(r){if(r.value){if(t.disableVertexAttribArray(e),4!==r.value.length)throw new Error("The length of an integer constant value must be 4!");t.vertexAttrib4iv(e,r.value)}else t.bindBuffer(34962,r.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,r.numComponents||r.size,r.type||5124,r.stride||0,r.offset||0),void 0!==r.divisor&&t.vertexAttribDivisor(e,r.divisor)}}function Lt(t,e){return function(r){if(r.value){if(t.disableVertexAttribArray(e),4!==r.value.length)throw new Error("The length of an unsigned integer constant value must be 4!");t.vertexAttrib4uiv(e,r.value)}else t.bindBuffer(34962,r.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,r.numComponents||r.size,r.type||5125,r.stride||0,r.offset||0),void 0!==r.divisor&&t.vertexAttribDivisor(e,r.divisor)}}function Ct(t,e,r){const i=r.size,n=r.count;return function(r){t.bindBuffer(34962,r.buffer);const a=r.size||r.numComponents||i,o=a/n,s=r.type||5126,u=wt[s].size*a,h=r.normalize||!1,f=r.offset||0,c=u/n;for(let i=0;i<n;++i)t.enableVertexAttribArray(e+i),t.vertexAttribPointer(e+i,o,s,h,u,f+c*i),void 0!==r.divisor&&t.vertexAttribDivisor(e+i,r.divisor)}}wt[5126]={Type:Float32Array,size:4,setter:function(t,e){return function(r){t.uniform1f(e,r)}},arraySetter:function(t,e){return function(r){t.uniform1fv(e,r)}}},wt[35664]={Type:Float32Array,size:8,setter:function(t,e){return function(r){t.uniform2fv(e,r)}}},wt[35665]={Type:Float32Array,size:12,setter:function(t,e){return function(r){t.uniform3fv(e,r)}}},wt[35666]={Type:Float32Array,size:16,setter:function(t,e){return function(r){t.uniform4fv(e,r)}}},wt[5124]={Type:Int32Array,size:4,setter:Ft,arraySetter:Pt},wt[35667]={Type:Int32Array,size:8,setter:Et},wt[35668]={Type:Int32Array,size:12,setter:xt},wt[35669]={Type:Int32Array,size:16,setter:Tt},wt[5125]={Type:Uint32Array,size:4,setter:function(t,e){return function(r){t.uniform1ui(e,r)}},arraySetter:function(t,e){return function(r){t.uniform1uiv(e,r)}}},wt[36294]={Type:Uint32Array,size:8,setter:function(t,e){return function(r){t.uniform2uiv(e,r)}}},wt[36295]={Type:Uint32Array,size:12,setter:function(t,e){return function(r){t.uniform3uiv(e,r)}}},wt[36296]={Type:Uint32Array,size:16,setter:function(t,e){return function(r){t.uniform4uiv(e,r)}}},wt[35670]={Type:Uint32Array,size:4,setter:Ft,arraySetter:Pt},wt[35671]={Type:Uint32Array,size:8,setter:Et},wt[35672]={Type:Uint32Array,size:12,setter:xt},wt[35673]={Type:Uint32Array,size:16,setter:Tt},wt[35674]={Type:Float32Array,size:16,setter:function(t,e){return function(r){t.uniformMatrix2fv(e,!1,r)}}},wt[35675]={Type:Float32Array,size:36,setter:function(t,e){return function(r){t.uniformMatrix3fv(e,!1,r)}}},wt[35676]={Type:Float32Array,size:64,setter:function(t,e){return function(r){t.uniformMatrix4fv(e,!1,r)}}},wt[35685]={Type:Float32Array,size:24,setter:function(t,e){return function(r){t.uniformMatrix2x3fv(e,!1,r)}}},wt[35686]={Type:Float32Array,size:32,setter:function(t,e){return function(r){t.uniformMatrix2x4fv(e,!1,r)}}},wt[35687]={Type:Float32Array,size:24,setter:function(t,e){return function(r){t.uniformMatrix3x2fv(e,!1,r)}}},wt[35688]={Type:Float32Array,size:48,setter:function(t,e){return function(r){t.uniformMatrix3x4fv(e,!1,r)}}},wt[35689]={Type:Float32Array,size:32,setter:function(t,e){return function(r){t.uniformMatrix4x2fv(e,!1,r)}}},wt[35690]={Type:Float32Array,size:48,setter:function(t,e){return function(r){t.uniformMatrix4x3fv(e,!1,r)}}},wt[35678]={Type:null,size:0,setter:St,arraySetter:_t,bindPoint:3553},wt[35680]={Type:null,size:0,setter:St,arraySetter:_t,bindPoint:34067},wt[35679]={Type:null,size:0,setter:St,arraySetter:_t,bindPoint:32879},wt[35682]={Type:null,size:0,setter:St,arraySetter:_t,bindPoint:3553},wt[36289]={Type:null,size:0,setter:St,arraySetter:_t,bindPoint:35866},wt[36292]={Type:null,size:0,setter:St,arraySetter:_t,bindPoint:35866},wt[36293]={Type:null,size:0,setter:St,arraySetter:_t,bindPoint:34067},wt[36298]={Type:null,size:0,setter:St,arraySetter:_t,bindPoint:3553},wt[36299]={Type:null,size:0,setter:St,arraySetter:_t,bindPoint:32879},wt[36300]={Type:null,size:0,setter:St,arraySetter:_t,bindPoint:34067},wt[36303]={Type:null,size:0,setter:St,arraySetter:_t,bindPoint:35866},wt[36306]={Type:null,size:0,setter:St,arraySetter:_t,bindPoint:3553},wt[36307]={Type:null,size:0,setter:St,arraySetter:_t,bindPoint:32879},wt[36308]={Type:null,size:0,setter:St,arraySetter:_t,bindPoint:34067},wt[36311]={Type:null,size:0,setter:St,arraySetter:_t,bindPoint:35866};const Bt={};function Rt(t){const e=t.name;return e.startsWith("gl_")||e.startsWith("webgl_")}function Mt(t,e){const r=t.uniformSetters||t,i=arguments.length;for(let t=1;t<i;++t){const e=arguments[t];if(Array.isArray(e)){const t=e.length;for(let i=0;i<t;++i)Mt(r,e[i])}else for(const t in e){const i=r[t];i&&i(e[t])}}}function It(t,e){const r={program:e,uniformSetters:function(t,e){let r=0;function i(e,i,n){const a=i.name.endsWith("[0]"),o=i.type,s=wt[o];if(!s)throw new Error("unknown type: 0x"+o.toString(16));let u;if(s.bindPoint){const e=r;r+=i.size,u=a?s.arraySetter(t,o,e,n,i.size):s.setter(t,o,e,n,i.size)}else u=s.arraySetter&&a?s.arraySetter(t,n):s.setter(t,n);return u.location=n,u}const n={},a=t.getProgramParameter(e,35718);for(let r=0;r<a;++r){const a=t.getActiveUniform(e,r);if(Rt(a))continue;let o=a.name;o.endsWith("[0]")&&(o=o.substr(0,o.length-3));const s=t.getUniformLocation(e,a.name);s&&(n[o]=i(0,a,s))}return n}(t,e),attribSetters:function(t,e){const r={},i=t.getProgramParameter(e,35721);for(let n=0;n<i;++n){const i=t.getActiveAttrib(e,n);if(Rt(i))continue;const a=t.getAttribLocation(e,i.name),o=Bt[i.type],s=o.setter(t,a,o);s.location=a,r[i.name]=s}return r}(t,e)};return bt(t)&&(r.uniformBlockSpec=function(t,e){const r=t.getProgramParameter(e,35718),i=[],n=[];for(let a=0;a<r;++a){n.push(a),i.push({});const r=t.getActiveUniform(e,a);if(Rt(r))break;i[a].name=r.name}[["UNIFORM_TYPE","type"],["UNIFORM_SIZE","size"],["UNIFORM_BLOCK_INDEX","blockNdx"],["UNIFORM_OFFSET","offset"]].forEach((function(r){const a=r[0],o=r[1];t.getActiveUniforms(e,n,t[a]).forEach((function(t,e){i[e][o]=t}))}));const a={},o=t.getProgramParameter(e,35382);for(let r=0;r<o;++r){const i=t.getActiveUniformBlockName(e,r),n={index:t.getUniformBlockIndex(e,i),usedByVertexShader:t.getActiveUniformBlockParameter(e,r,35396),usedByFragmentShader:t.getActiveUniformBlockParameter(e,r,35398),size:t.getActiveUniformBlockParameter(e,r,35392),uniformIndices:t.getActiveUniformBlockParameter(e,r,35395)};n.used=n.usedByVertexShader||n.usedByFragmentShader,a[i]=n}return{blockSpecs:a,uniformData:i}}(t,e),r.transformFeedbackInfo=function(t,e){const r={},i=t.getProgramParameter(e,35971);for(let n=0;n<i;++n){const i=t.getTransformFeedbackVarying(e,n);r[i.name]={index:n,type:i.type,size:i.size}}return r}(t,e)),r}Bt[5126]={size:4,setter:Ut},Bt[35664]={size:8,setter:Ut},Bt[35665]={size:12,setter:Ut},Bt[35666]={size:16,setter:Ut},Bt[5124]={size:4,setter:kt},Bt[35667]={size:8,setter:kt},Bt[35668]={size:12,setter:kt},Bt[35669]={size:16,setter:kt},Bt[5125]={size:4,setter:Lt},Bt[36294]={size:8,setter:Lt},Bt[36295]={size:12,setter:Lt},Bt[36296]={size:16,setter:Lt},Bt[35670]={size:4,setter:kt},Bt[35671]={size:8,setter:kt},Bt[35672]={size:12,setter:kt},Bt[35673]={size:16,setter:kt},Bt[35674]={size:4,setter:Ct,count:2},Bt[35675]={size:9,setter:Ct,count:3},Bt[35676]={size:16,setter:Ct,count:4};var Ot="#define GLSLIFY 1\nattribute vec4 position;attribute vec2 texcoord;varying vec2 v_texel;varying vec2 v_uv;varying float v_scale;uniform bool u_flipY;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){v_uv=texcoord;v_scale=floor(u_screenSize.y/u_textureSize.y+0.01);gl_Position=position;if(u_flipY){gl_Position.y*=-1.;}}",zt=function(){function t(e,r,n,a){var o=this;void 0===r&&(r=640),void 0===n&&(n=480),void 0===a&&(a={}),this.refs={programs:[],shaders:[],textures:[],buffers:[],framebuffers:[]},this.isCtxLost=!1,this.handleContextLoss=function(t){t.preventDefault(),o.destroy(),o.isCtxLost=!0,o.options.onlost()},this.handleContextRestored=function(t){o.isCtxLost=!1,o.init(),o.options.onrestored()},v(),this.el=e,this.width=r,this.height=n,this.options=i(i({},t.defaultOptions),a),e.addEventListener("webglcontextlost",this.handleContextLoss,!1),e.addEventListener("webglcontextrestored",this.handleContextRestored,!1),this.gl=e.getContext("webgl",{antialias:!1,alpha:!0}),this.init()}return t.prototype.init=function(){var t=this.gl;this.layerDrawProgram=this.createProgram(Ot,"precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_palette;uniform sampler2D u_bitmap;uniform float u_paletteOffset;const vec4 transparent=vec4(0,0,0,0);void main(){float index=texture2D(u_bitmap,v_uv).a*255.;if(index>0.){gl_FragColor=texture2D(u_palette,vec2((u_paletteOffset+index)/8.,.5));}else{gl_FragColor=transparent;}}"),this.postProcessProgram=this.createProgram(Ot,"precision highp float;\n#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_tex;varying float v_scale;uniform vec2 u_textureSize;uniform vec2 u_screenSize;void main(){vec2 v_texel=v_uv*u_textureSize;vec2 texel_floored=floor(v_texel);vec2 s=fract(v_texel);float region_range=0.5-0.5/v_scale;vec2 center_dist=s-0.5;vec2 f=(center_dist-clamp(center_dist,-region_range,region_range))*v_scale+0.5;vec2 mod_texel=texel_floored+f;vec2 coord=mod_texel.xy/u_textureSize.xy;gl_FragColor=texture2D(u_tex,coord);}"),this.quadBuffer=this.createScreenQuad(-1,-1,2,2,8,8),this.setBuffersAndAttribs(this.layerDrawProgram,this.quadBuffer),this.setBuffersAndAttribs(this.postProcessProgram,this.quadBuffer),this.paletteData=new Uint8Array(32),this.paletteTexture=this.createTexture(t.RGBA,t.NEAREST,t.CLAMP_TO_EDGE,8,1),this.layerTexture=this.createTexture(t.ALPHA,t.NEAREST,t.CLAMP_TO_EDGE),this.frameTexture=this.createTexture(t.RGBA,t.LINEAR,t.CLAMP_TO_EDGE),this.frameBuffer=this.createFrameBuffer(this.frameTexture),this.setCanvasSize(this.width,this.height)},t.prototype.createProgram=function(t,e){y(!this.isCtxLost);var r=this.gl,i=this.createShader(r.VERTEX_SHADER,t),n=this.createShader(r.FRAGMENT_SHADER,e),a=r.createProgram();if(r.attachShader(a,i),r.attachShader(a,n),r.linkProgram(a),!r.getProgramParameter(a,r.LINK_STATUS)){var o=r.getProgramInfoLog(a);throw r.deleteProgram(a),new Error(o)}var s=It(r,a);return this.refs.programs.push(a),s},t.prototype.createShader=function(t,e){y(!this.isCtxLost);var r=this.gl,i=r.createShader(t);if(r.shaderSource(i,e),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS)){var n=r.getShaderInfoLog(i);throw r.deleteShader(i),new Error(n)}return this.refs.shaders.push(i),i},t.prototype.createScreenQuad=function(t,e,r,i,n,a){y(!this.isCtxLost);for(var o=(n+1)*(a+1),s=n+1,u=new Float32Array(2*o),h=new Float32Array(2*o),f=0,c=0,l=0;l<=a;l++)for(var p=0;p<=n;p++){var d=p/n,m=l/a;u[f++]=t+r*d,u[f++]=e+i*m,h[c++]=d,h[c++]=m}var g=new Uint16Array(n*a*2*3),v=0;for(l=0;l<a;l++)for(p=0;p<n;p++)g[v++]=(l+0)*s+p,g[v++]=(l+1)*s+p,g[v++]=(l+0)*s+p+1,g[v++]=(l+0)*s+p+1,g[v++]=(l+1)*s+p,g[v++]=(l+1)*s+p+1;var b=vt(this.gl,{position:{numComponents:2,data:u},texcoord:{numComponents:2,data:h},indices:g});for(var w in b.attribs)this.refs.buffers.push(b.attribs[w].buffer);return b},t.prototype.setBuffersAndAttribs=function(t,e){var r=this.gl;!function(t,e){for(const r in e){const i=t[r];i&&i(e[r])}}(t.attribSetters,e.attribs),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,e.indices)},t.prototype.createTexture=function(t,e,r,i,n){void 0===i&&(i=1),void 0===n&&(n=1),y(!this.isCtxLost);var a=this.gl,o=a.createTexture();return a.bindTexture(a.TEXTURE_2D,o),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,r),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,r),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,e),a.texImage2D(a.TEXTURE_2D,0,t,i,n,0,t,a.UNSIGNED_BYTE,null),this.refs.textures.push(o),o},t.prototype.createFrameBuffer=function(t){y(!this.isCtxLost);var e=this.gl,r=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,r),e.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),this.refs.framebuffers.push(r),r},t.prototype.setCanvasSize=function(t,e){y(!this.isCtxLost);var r=window.devicePixelRatio||1,i=t*r,n=e*r;this.width=t,this.height=e,this.el.width=i,this.el.height=n,this.screenWidth=i,this.screenHeight=n,this.el.style.width=t+"px",this.el.style.height=e+"px"},t.prototype.setInputSize=function(t,e){var r=this.gl;this.textureWidth=t,this.textureHeight=e,r.bindTexture(r.TEXTURE_2D,this.frameTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this.textureWidth,this.textureHeight,0,r.RGBA,r.UNSIGNED_BYTE,null)},t.prototype.clearFrameBuffer=function(t){y(!this.isCtxLost);var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer),e.viewport(0,0,this.textureWidth,this.textureHeight);var r=t[0],i=t[1],n=t[2],a=t[3];e.clearColor(r/255,i/255,n/255,a/255),e.clear(e.COLOR_BUFFER_BIT)},t.prototype.setPalette=function(t){y(!this.isCtxLost),y(t.length<16);for(var e=this.gl,r=this.paletteData.fill(0),i=0,n=0;n<t.length;n++){var a=t[n],o=a[0],s=a[1],u=a[2],h=a[3];r[i++]=o,r[i++]=s,r[i++]=u,r[i++]=h}e.bindTexture(e.TEXTURE_2D,this.paletteTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,8,1,0,e.RGBA,e.UNSIGNED_BYTE,r)},t.prototype.drawPixels=function(t,e){var r=this,i=r.gl,n=r.layerDrawProgram,a=r.layerTexture,o=r.textureWidth,s=r.textureHeight;y(!this.isCtxLost),y(t.length===o*s),i.bindFramebuffer(i.FRAMEBUFFER,this.frameBuffer),i.viewport(0,0,o,s),i.useProgram(n.program),i.bindTexture(i.TEXTURE_2D,a),i.texImage2D(i.TEXTURE_2D,0,i.ALPHA,o,s,0,i.ALPHA,i.UNSIGNED_BYTE,t),Mt(n,{u_palette:this.paletteTexture,u_paletteOffset:e,u_bitmap:a,u_textureSize:[o,s],u_screenSize:[i.drawingBufferWidth,i.drawingBufferHeight]}),i.drawElements(i.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)},t.prototype.composite=function(){var t=this.gl;y(!this.isCtxLost),t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),t.useProgram(this.postProcessProgram.program),t.clear(t.COLOR_BUFFER_BIT),Mt(this.postProcessProgram,{u_flipY:!0,u_tex:this.frameTexture,u_textureSize:[this.textureWidth,this.textureHeight],u_screenSize:[t.drawingBufferWidth,t.drawingBufferHeight]}),t.drawElements(t.TRIANGLES,this.quadBuffer.numElements,this.quadBuffer.elementType,0)},t.prototype.isErrorState=function(){var t=this.gl,e=t.getError();return e!=t.NO_ERROR&&e!=t.CONTEXT_LOST_WEBGL},t.prototype.isLost=function(){return this.gl.isContextLost()},t.prototype.destroy=function(){return n(this,void 0,void 0,(function(){var t,e;return a(this,(function(r){return t=this.refs,e=this.gl,t.shaders.forEach((function(t){e.deleteShader(t)})),t.shaders=[],t.framebuffers.forEach((function(t){e.deleteFramebuffer(t)})),t.framebuffers=[],t.textures.forEach((function(t){e.deleteTexture(t)})),t.textures=[],t.buffers.forEach((function(t){e.deleteBuffer(t)})),t.buffers=[],t.programs.forEach((function(t){e.deleteProgram(t)})),t.programs=[],this.paletteData=null,e.canvas.width=1,e.canvas.height=1,[2]}))}))},t.defaultOptions={onlost:function(){},onrestored:function(){}},t}(),Nt=g?window.AudioContext||window.webkitAudioContext:null,Dt=function(){function t(){this.useEq=!1,this.eqSettings=[[31.25,4.1],[62.5,1.2],[125,0],[250,-4.1],[500,-2.3],[1e3,.5],[2e3,6.5],[8e3,5.1],[16e3,5.1]],this._volume=1,this._loop=!1,this.nodeRefs=[],v()}return Object.defineProperty(t.prototype,"volume",{get:function(){return this._volume},set:function(t){this.setVolume(t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=t,this.source&&(this.source.loop=t)},enumerable:!1,configurable:!0}),t.prototype.getCtx=function(){return this.ctx||(this.ctx=new Nt),this.ctx},t.prototype.setBuffer=function(t,e){var r=this.getCtx(),i=t.length,n=r.createBuffer(1,i,e),a=n.getChannelData(0);if(t instanceof Float32Array)a.set(t,0);else if(t instanceof Int16Array)for(var o=0;o<i;o++)a[o]=t[o]/32768;this.buffer=n,this.sampleRate=e},t.prototype.connectEqNodesTo=function(t){var e=this,r=this.getCtx(),i=this.eqSettings,n=t;return i.forEach((function(t,a){var o=t[0],s=t[1],u=r.createBiquadFilter();e.nodeRefs.push(u),u.frequency.value=o,u.gain.value=s,0===a?u.type="lowshelf":a===i.length-1?u.type="highshelf":u.type="peaking",n.connect(u),n=u})),n},t.prototype.initNodes=function(){var t=this.getCtx();this.nodeRefs=[];var e=t.createBufferSource();this.nodeRefs.push(e),e.buffer=this.buffer;var r=t.createGain();(this.nodeRefs.push(r),this.useEq)?this.connectEqNodesTo(e).connect(r):e.connect(r);e.connect(r),r.connect(t.destination),this.source=e,this.gainNode=r,this.setVolume(this._volume)},t.prototype.setVolume=function(t){this._volume=t,this.gainNode&&(this.gainNode.gain.value=Math.pow(t,2))},t.prototype.playFrom=function(t){this.initNodes(),this.source.loop=this._loop,this.source.start(0,t)},t.prototype.stop=function(){this.source&&this.source.stop(0)},t.prototype.destroy=function(){return n(this,void 0,void 0,(function(){var t;return a(this,(function(e){switch(e.label){case 0:return this.stop(),t=this.getCtx(),this.nodeRefs.forEach((function(t){return t.disconnect()})),this.nodeRefs=[],"closed"===t.state||"function"!=typeof t.close?[3,2]:[4,t.close()];case 1:e.sent(),e.label=2;case 2:return this.buffer=null,[2]}}))}))},t}();function Ht(t){return{length:t.length,start:function(e){return t[e][0]},end:function(e){return t[e][1]}}}function Wt(t,e){return t.toString().padStart(e,"0")}function Vt(t){return Math.floor(t%3600/60)+":"+Wt(Math.floor(t%60),2)}var jt=function(){function e(e,r,i){var n=this;this.duration=0,this.autoplay=!1,this.supportedEvents=at,this._src=null,this._loop=!1,this._volume=1,this._muted=!1,this._frame=null,this.isNoteLoaded=!1,this.events=new Map,this.playbackStartTime=0,this.playbackTime=0,this.playbackLoopId=null,this.showThumbnail=!0,this.hasPlaybackStarted=!1,this.isPlaying=!1,this.wasPlaying=!1,this.isSeeking=!1,this.playbackLoop=function(e){if(n.isPlaying){var r=e/1e3,i=r-n.playbackStartTime;i>=n.duration&&(n.loop?(n.playbackStartTime=r,n.emit(t.PlayerEvent.Loop)):(n.pause(),n.emit(t.PlayerEvent.Ended))),n.setCurrentTime(i%n.duration),n.playbackLoopId=requestAnimationFrame(n.playbackLoop)}},v(),e="string"==typeof e?document.querySelector(e):e,this.renderer=new zt(e,r,i,{onlost:function(){return n.emit(t.PlayerEvent.Error)},onrestored:function(){return n.load()}}),this.audio=new Dt,this.canvasEl=this.renderer.el}return Object.defineProperty(e.prototype,"src",{get:function(){return this._src},set:function(t){this.load(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"paused",{get:function(){return!this.isPlaying},set:function(t){t?this.pause():this.play()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentFrame",{get:function(){return this._frame},set:function(t){this.setCurrentFrame(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentTime",{get:function(){return this.isNoteLoaded?this.playbackTime:null},set:function(t){this.setCurrentTime(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"progress",{get:function(){return this.isNoteLoaded?this.playbackTime/this.duration*100:null},set:function(t){this.setProgress(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"volume",{get:function(){return this.getVolume()},set:function(t){this.setVolume(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"muted",{get:function(){return this.getMuted()},set:function(t){this.setMuted(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loop",{get:function(){return this.getLoop()},set:function(t){this.setLoop(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"framerate",{get:function(){return this.note.framerate},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"frameCount",{get:function(){return this.note.frameCount},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"frameSpeed",{get:function(){return this.note.frameSpeed},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"buffered",{get:function(){return Ht([[0,this.duration]])},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"seekable",{get:function(){return Ht([[0,this.duration]])},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentSrc",{get:function(){return this._src},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"videoWidth",{get:function(){return this.isNoteLoaded?this.note.imageWidth:0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"videoHeight",{get:function(){return this.isNoteLoaded?this.note.imageHeight:0},enumerable:!1,configurable:!0}),e.prototype.load=function(e){return void 0===e&&(e=null),n(this,void 0,void 0,(function(){var r=this;return a(this,(function(i){return this.isNoteLoaded&&this.closeNote(),e?(this.emit(t.PlayerEvent.LoadStart),[2,nt(e).then((function(t){r.openNote(t),r._src=e})).catch((function(e){throw r.emit(t.PlayerEvent.Error,e),new Error("Error loading Flipnote: "+e.message)}))]):[2,this.openNote(this.note)]}))}))},e.prototype.closeNote=function(){this.pause(),this.note=null,this.isNoteLoaded=!1,this.meta=null,this._src=null,this._frame=0,this.playbackTime=0,this.duration=0,this.loop=!1,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.showThumbnail=!0,this.renderer.clearFrameBuffer([0,0,0,0])},e.prototype.openNote=function(e){this.isNoteLoaded&&this.closeNote(),this.note=e,this.meta=e.meta,this.emit(t.PlayerEvent.LoadedMeta),this.noteFormat=e.format,this.duration=e.duration,this.playbackTime=0,this._frame=0,this.isNoteLoaded=!0,this.isPlaying=!1,this.wasPlaying=!1,this.hasPlaybackStarted=!1,this.layerVisibility=e.layerVisibility,this.showThumbnail=!0,this.audio.setBuffer(e.getAudioMasterPcm(),e.sampleRate),this.emit(t.PlayerEvent.CanPlay),this.emit(t.PlayerEvent.CanPlayThrough),this.setLoop(e.meta.loop),this.renderer.setInputSize(e.imageWidth,e.imageHeight),this.drawFrame(e.thumbFrameIndex),this.emit(t.PlayerEvent.LoadedData),this.emit(t.PlayerEvent.Load),this.emit(t.PlayerEvent.Ready),this.autoplay&&this.play()},e.prototype.setCurrentTime=function(e){this.assertNoteLoaded();var r=Math.floor(e/(1/this.framerate));this.setCurrentFrame(r),this.playbackTime=e,this.emit(t.PlayerEvent.Progress,this.progress)},e.prototype.getCurrentTime=function(){return this.currentTime},e.prototype.getTimeCounter=function(){return Vt(Math.max(this.currentTime,0))+" / "+Vt(this.duration)},e.prototype.getFrameCounter=function(){return Wt(this.currentFrame+1,3)+" / "+Wt(this.frameCount,3)},e.prototype.setProgress=function(t){this.assertNoteLoaded(),m(t,0,100,"progress"),this.currentTime=this.duration*(t/100)},e.prototype.getProgress=function(){return this.progress},e.prototype.play=function(){return n(this,void 0,void 0,(function(){var e;return a(this,(function(r){return this.assertNoteLoaded(),this.isPlaying||(this.isPlaying=!0,this.hasPlaybackStarted=!0,e=performance.now(),this.playbackStartTime=e/1e3-this.playbackTime,this.playAudio(),this.playbackLoop(e),this.emit(t.PlayerEvent.Play)),[2]}))}))},e.prototype.pause=function(){this.isPlaying&&(this.isPlaying=!1,null!==this.playbackLoopId&&cancelAnimationFrame(this.playbackLoopId),this.stopAudio(),this.emit(t.PlayerEvent.Pause))},e.prototype.togglePlay=function(){this.isPlaying?this.pause():this.play()},e.prototype.getPaused=function(){return!this.isPlaying},e.prototype.getDuration=function(){return this.duration},e.prototype.getLoop=function(){return this._loop},e.prototype.setLoop=function(t){this._loop=t,this.audio.loop=t},e.prototype.toggleLoop=function(){this.setLoop(!this._loop)},e.prototype.setCurrentFrame=function(e){this.assertNoteLoaded();var r=Math.max(0,Math.min(Math.floor(e),this.frameCount-1));(r!==this.currentFrame||this.showThumbnail)&&(this._frame=r,this.drawFrame(r),this.showThumbnail=!1,this.isPlaying||(this.playbackTime=r*(1/this.framerate),this.emit(t.PlayerEvent.SeekEnd)),this.emit(t.PlayerEvent.FrameUpdate,this.currentFrame),this.emit(t.PlayerEvent.Progress,this.progress),this.emit(t.PlayerEvent.TimeUpdate,this.currentFrame))},e.prototype.nextFrame=function(){this.loop&&this.currentFrame===this.frameCount-1?this.currentFrame=0:this.currentFrame+=1,this.emit(t.PlayerEvent.FrameNext)},e.prototype.prevFrame=function(){this.loop&&0===this.currentFrame?this.currentFrame=this.frameCount-1:this.currentFrame-=1,this.emit(t.PlayerEvent.FramePrev)},e.prototype.lastFrame=function(){this.currentFrame=this.frameCount-1,this.emit(t.PlayerEvent.FrameLast)},e.prototype.firstFrame=function(){this.currentFrame=0,this.emit(t.PlayerEvent.FrameFirst)},e.prototype.thumbnailFrame=function(){this.currentFrame=this.note.thumbFrameIndex},e.prototype.startSeek=function(){this.isSeeking||(this.emit(t.PlayerEvent.SeekStart),this.wasPlaying=this.isPlaying,this.pause(),this.isSeeking=!0)},e.prototype.seek=function(t){this.isSeeking&&(this.progress=100*t)},e.prototype.endSeek=function(){this.isSeeking&&!0===this.wasPlaying&&this.play(),this.wasPlaying=!1,this.isSeeking=!1},e.prototype.drawFrame=function(e){var r=this.note,i=this.renderer,n=r.getFramePalette(e),a=r.decodeFrame(e),o=this.layerVisibility;if(i.setPalette(n),i.clearFrameBuffer(n[0]),r.format===t.FlipnoteFormat.PPM)o[2]&&i.drawPixels(a[1],1),o[1]&&i.drawPixels(a[0],0);else if(r.format===t.FlipnoteFormat.KWZ){var s=r.getFrameLayerOrder(e),u=s[0],h=s[1],f=s[2];o[u+1]&&i.drawPixels(a[u],2*u),o[h+1]&&i.drawPixels(a[h],2*h),o[f+1]&&i.drawPixels(a[f],2*f)}i.composite()},e.prototype.forceUpdate=function(){this.isNoteLoaded&&this.drawFrame(this.currentFrame)},e.prototype.resize=function(t,e){e!==.75*t&&console.warn("Canvas width to height ratio should be 3:4 for best results (got "+t+"x"+e+")"),this.renderer.setCanvasSize(t,e),this.forceUpdate()},e.prototype.setLayerVisibility=function(t,e){this.layerVisibility[t]=e,this.forceUpdate()},e.prototype.getLayerVisibility=function(t){return this.layerVisibility[t]},e.prototype.toggleLayerVisibility=function(t){this.setLayerVisibility(t,!this.layerVisibility[t])},e.prototype.playAudio=function(){this.audio.playFrom(this.currentTime)},e.prototype.stopAudio=function(){this.audio.stop()},e.prototype.toggleAudioEq=function(){this.setAudioEq(!this.audio.useEq)},e.prototype.setAudioEq=function(t){this.isPlaying&&(this.wasPlaying=!0,this.stopAudio()),this.audio.useEq=t,this.wasPlaying&&(this.wasPlaying=!1,this.playAudio())},e.prototype.mute=function(){this.setMuted(!0)},e.prototype.unmute=function(){this.setMuted(!1)},e.prototype.setMuted=function(e){this.audio.volume=e?0:this._volume,this._muted=e,this.emit(t.PlayerEvent.VolumeChange,this.audio.volume)},e.prototype.getMuted=function(){return 0===this.volume||this._muted},e.prototype.toggleMuted=function(){this.setMuted(!this._muted)},e.prototype.setVolume=function(e){m(e,0,1,"volume"),this._volume=e,this.audio.volume=e,this.emit(t.PlayerEvent.VolumeChange,this.audio.volume)},e.prototype.getVolume=function(){return this._muted?0:this._volume},e.prototype.seekToNextFrame=function(){this.nextFrame()},e.prototype.fastSeek=function(t){this.currentTime=t},e.prototype.canPlayType=function(t){switch(t){case"application/x-ppm":case"application/x-kwz":case"video/x-ppm":case"video/x-kwz":case"video/vnd.nintendo.ugomemo.ppm":case"video/vnd.nintendo.ugomemo.kwz":return"probably";case"application/octet-stream":return"maybe";case"video/vnd.nintendo.ugomemo.fykt":default:return""}},e.prototype.getVideoPlaybackQuality=function(){return{creationTime:0,droppedVideoFrames:0,totalVideoFrames:this.frameCount}},e.prototype.requestPictureInPicture=function(){throw new Error("Not implemented")},e.prototype.captureStream=function(){throw new Error("Not implemented")},e.prototype.on=function(t,e){var r=this.events;(Array.isArray(t)?t:[t]).forEach((function(t){r.has(t)?r.get(t).push(e):r.set(t,[e])}))},e.prototype.off=function(t,e){var r=this.events;(Array.isArray(t)?t:[t]).forEach((function(t){if(r.has(t)){var i=r.get(t);r.set(t,i.splice(i.indexOf(e),1))}}))},e.prototype.emit=function(e){for(var r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];var n=this.events;if(e!==t.PlayerEvent.__Any&&n.has(e)){n.get(e).forEach((function(t){return t.apply(null,r)}));var a="on"+e,s=this;"function"==typeof s[a]&&s[a].apply(null,r)}n.has(t.PlayerEvent.__Any)&&n.get(t.PlayerEvent.__Any).forEach((function(t){return t.apply(null,o([e],r))}))},e.prototype.clearEvents=function(){this.events.clear()},e.prototype.destroy=function(){return n(this,void 0,void 0,(function(){return a(this,(function(e){switch(e.label){case 0:return this.clearEvents(),this.emit(t.PlayerEvent.Destroy),this.closeNote(),[4,this.renderer.destroy()];case 1:return e.sent(),[4,this.audio.destroy()];case 2:return e.sent(),[2]}}))}))},e.prototype.supports=function(t){var e=this.supportedEvents.includes(t),r="function"==typeof this[t];return e||r},e.prototype.assertNoteLoaded=function(){y(this.isNoteLoaded,"No Flipnote is currently loaded in this player")},e}();var Gt=function(){function t(){this.dataUrl=null}return t.prototype.getBuffer=function(){return y(b,"This feature is only available in NodeJS environments"),Buffer.from(this.getArrayBuffer())},t.prototype.getBlob=function(){return v(),new Blob([this.getArrayBuffer()],{type:this.mimeType})},t.prototype.getUrl=function(){return v(),this.dataUrl?this.dataUrl:window.URL.createObjectURL(this.getBlob())},t.prototype.revokeUrl=function(){v(),this.dataUrl&&window.URL.revokeObjectURL(this.dataUrl)},t}(),Kt=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],qt=function(){function t(t,e,r){this.accum=new Uint8Array(256),this.htab=new Int32Array(5003),this.codetab=new Int32Array(5003),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0,this.width=t,this.height=e,this.colorDepth=r,this.reset()}return t.prototype.reset=function(){this.initCodeSize=Math.max(2,this.colorDepth),this.accum.fill(0),this.htab.fill(0),this.codetab.fill(0),this.cur_accum=0,this.cur_bits=0,this.curPixel=0,this.free_ent=0,this.maxcode,this.clear_flg=!1,this.g_init_bits=void 0,this.ClearCode=void 0,this.EOFCode=void 0},t.prototype.char_out=function(t,e){this.accum[this.a_count++]=t,this.a_count>=254&&this.flush_char(e)},t.prototype.cl_block=function(t){this.cl_hash(5003),this.free_ent=this.ClearCode+2,this.clear_flg=!0,this.output(this.ClearCode,t)},t.prototype.cl_hash=function(t){for(var e=0;e<t;++e)this.htab[e]=-1},t.prototype.compress=function(t,e){var r,i,n,a,o,s;for(this.g_init_bits=t,this.clear_flg=!1,this.n_bits=this.g_init_bits,this.maxcode=this.get_maxcode(this.n_bits),this.ClearCode=1<<t-1,this.EOFCode=this.ClearCode+1,this.free_ent=this.ClearCode+2,this.a_count=0,a=this.nextPixel(),s=0,r=5003;r<65536;r*=2)++s;s=8-s,this.cl_hash(5003),this.output(this.ClearCode,e);t:for(;-1!=(i=this.nextPixel());)if(r=(i<<12)+a,n=i<<s^a,this.htab[n]!==r){if(this.htab[n]>=0){o=5003-n,0===n&&(o=1);do{if((n-=o)<0&&(n+=5003),this.htab[n]===r){a=this.codetab[n];continue t}}while(this.htab[n]>=0)}this.output(a,e),a=i,this.free_ent<4096?(this.codetab[n]=this.free_ent++,this.htab[n]=r):this.cl_block(e)}else a=this.codetab[n];this.output(a,e),this.output(this.EOFCode,e)},t.prototype.encode=function(t,e){this.pixels=t,e.writeByte(this.initCodeSize),this.remaining=this.width*this.height,this.curPixel=0,this.compress(this.initCodeSize+1,e),e.writeByte(0)},t.prototype.flush_char=function(t){this.a_count>0&&(t.writeByte(this.a_count),t.writeBytes(this.accum,0,this.a_count),this.a_count=0)},t.prototype.get_maxcode=function(t){return(1<<t)-1},t.prototype.nextPixel=function(){return 0===this.remaining?-1:(--this.remaining,255&this.pixels[this.curPixel++])},t.prototype.output=function(t,e){for(this.cur_accum&=Kt[this.cur_bits],this.cur_bits>0?this.cur_accum|=t<<this.cur_bits:this.cur_accum=t,this.cur_bits+=this.n_bits;this.cur_bits>=8;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;if((this.free_ent>this.maxcode||this.clear_flg)&&(this.clear_flg?(this.maxcode=this.get_maxcode(this.n_bits=this.g_init_bits),this.clear_flg=!1):(++this.n_bits,12==this.n_bits?this.maxcode=4096:this.maxcode=this.get_maxcode(this.n_bits))),t==this.EOFCode){for(;this.cur_bits>0;)this.char_out(255&this.cur_accum,e),this.cur_accum>>=8,this.cur_bits-=8;this.flush_char(e)}},t}(),Xt=function(t){function e(r,n,a){void 0===a&&(a={});var o=t.call(this)||this;return o.mimeType="gif/image",o.frameCount=0,o.width=r,o.height=n,o.data=new s,o.settings=i(i({},e.defaultSettings),a),o.compressor=new qt(r,n,a.colorDepth),o}return r(e,t),e.fromFlipnote=function(t,r){var n;void 0===r&&(r={});var a=new e(t.imageWidth,t.imageHeight,i({delay:100/t.framerate,repeat:(null===(n=t.meta)||void 0===n?void 0:n.loop)?-1:0},r));a.palette=t.globalPalette;for(var o=0;o<t.frameCount;o++)a.writeFrame(t.getFramePixels(o));return a},e.fromFlipnoteFrame=function(t,r,n){void 0===n&&(n={});var a=new e(t.imageWidth,t.imageHeight,i({delay:100/t.framerate,repeat:-1},n));return a.palette=t.globalPalette,a.writeFrame(t.getFramePixels(r)),a},e.prototype.writeFrame=function(t){0===this.frameCount?this.writeFirstFrame(t):this.writeAdditionalFrame(t),this.frameCount+=1},e.prototype.writeFirstFrame=function(t){for(var e=this.palette.length,r=1;1<<r<e;r+=1)continue;this.settings.colorDepth=r,this.writeHeader(),this.writeColorTable(),this.writeNetscapeExt(),this.writeFrameHeader(),this.writePixels(t)},e.prototype.writeAdditionalFrame=function(t){this.writeFrameHeader(),this.writePixels(t)},e.prototype.writeHeader=function(){var t=new u(new ArrayBuffer(13));t.writeChars("GIF89a"),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(128|this.settings.colorDepth-1),t.writeBytes([0,0]),this.data.writeBytes(new Uint8Array(t.buffer))},e.prototype.writeColorTable=function(){for(var t=new Uint8Array(3*Math.pow(2,this.settings.colorDepth)),e=0,r=0;r<this.palette.length;r+=1){var i=this.palette[r],n=i[0],a=i[1],o=i[2];i[3];t[e++]=n,t[e++]=a,t[e++]=o}this.data.writeBytes(t)},e.prototype.writeNetscapeExt=function(){var t=new u(new ArrayBuffer(19));t.writeBytes([33,255,11]),t.writeChars("NETSCAPE2.0"),t.writeUint8(3),t.writeUint8(1),t.writeUint16(this.settings.repeat),this.data.writeBytes(new Uint8Array(t.buffer))},e.prototype.writeFrameHeader=function(){var t=new u(new ArrayBuffer(18)),e=this.settings.transparentBg?1:0;t.writeBytes([33,249,4,0|e]),t.writeUint16(this.settings.delay),t.writeBytes([0,0]),t.writeUint8(44),t.writeUint16(0),t.writeUint16(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint8(0),this.data.writeBytes(new Uint8Array(t.buffer))},e.prototype.writePixels=function(t){this.compressor.colorDepth=this.settings.colorDepth,this.compressor.reset(),this.compressor.encode(t,this.data)},e.prototype.getArrayBuffer=function(){return this.data.getBuffer()},e.prototype.getImage=function(){v();var t=new Image(this.width,this.height);return t.src=this.getUrl(),t},e.defaultSettings={transparentBg:!1,delay:100,repeat:-1,colorDepth:8},e}(Gt),Yt=function(t){function e(e,r,i){void 0===r&&(r=1),void 0===i&&(i=16);var n=t.call(this)||this;n.sampleRate=e,n.channels=r,n.bitsPerSample=i;var a=new ArrayBuffer(44),o=new u(a);return o.writeChars("RIFF"),o.writeUint32(0),o.writeChars("WAVE"),o.writeChars("fmt "),o.writeUint32(16),o.writeUint16(1),o.writeUint16(n.channels),o.writeUint32(n.sampleRate),o.writeUint32(n.sampleRate*n.bitsPerSample*n.channels/8),o.writeUint16(n.bitsPerSample*n.channels/8),o.writeUint16(n.bitsPerSample),o.writeChars("data"),o.writeUint32(0),n.header=o,n.pcmData=null,n}return r(e,t),e.fromFlipnote=function(t){var r=t.sampleRate,i=new e(r,1,16),n=t.getAudioMasterPcm(r);return i.writeSamples(n),i},e.fromFlipnoteTrack=function(t,r){var i=t.sampleRate,n=new e(i,1,16),a=t.getAudioTrackPcm(r,i);return n.writeSamples(a),n},e.prototype.writeSamples=function(t){var e=this.header;e.seek(4),e.writeUint32(e.byteLength+t.byteLength),e.seek(40),e.writeUint32(t.byteLength),this.pcmData=t},e.prototype.getArrayBuffer=function(){var t=this.header.bytes,e=new Uint8Array(this.pcmData.buffer),r=new Uint8Array(this.header.byteLength+this.pcmData.byteLength);return r.set(t),r.set(e,t.byteLength),r.buffer},e}(Gt);t.GifImage=Xt,t.KwzParser=rt,t.Player=jt,t.PlayerMixin=function(t){for(var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),Object.defineProperty(e.prototype,"renderer",{get:function(){return this.player.renderer},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"audio",{get:function(){return this.player.audio},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"canvasEl",{get:function(){return this.player.canvasEl},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"note",{get:function(){return this.player.note},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"noteFormat",{get:function(){return this.player.noteFormat},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"meta",{get:function(){return this.player.meta},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"duration",{get:function(){return this.player.duration},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"layerVisibility",{get:function(){return this.player.layerVisibility},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"autoplay",{get:function(){return this.player.autoplay},set:function(t){this.player.autoplay=t},enumerable:!1,configurable:!0}),e}(t),n=function(r){var n=Object.getOwnPropertyDescriptor(jt.prototype,r);if(r in t.prototype||"constructor"===r||"name"===r||"prototype"===r)return"continue";n.value&&"function"==typeof n.value?Object.defineProperty(e.prototype,r,i(i({},n),{value:function(){for(var t,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return(t=this.player)[r].apply(t,e)}})):(n.get||n.set)&&Object.defineProperty(e.prototype,r,i(i({},n),{set:function(t){this.player[r]=t},get:function(){return this.player[r]}}))},a=0,o=Reflect.ownKeys(jt.prototype);a<o.length;a++){n(o[a])}return e},t.PpmParser=O,t.WavAudio=Yt,t.parseSource=nt,t.utils=B,t.version="5.3.0",Object.defineProperty(t,"__esModule",{value:!0})}));
